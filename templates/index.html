<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapVisual - US Mobile Subscribers Visualization</title>
    
    <!-- Glassmorphism CSS -->
    <link rel="stylesheet" href="/static/css/glassmorphism.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>MapVisual Engine</h1>
        <p>Interactive US Mobile Subscribers Visualization</p>
    </div>
    
    <!-- Stats Panel -->
    <div class="stats-panel">
        <div class="glass-container stats-grid fade-in">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">-</div>
                <div class="stat-label">Total Subscribers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-states">-</div>
                <div class="stat-label">States Covered</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">4</div>
                <div class="stat-label">Carriers (3 Major + Others*)</div>
            </div>
        </div>
    </div>
    
    <!-- Others Disclaimer -->
    <div class="info-banner glass-container fade-in">
        <strong>Note on "Others":</strong> The "Others" category represents Cable (Xfinity/Spectrum), Dish, MVNOs, and resellers‚Äînot the same as Verizon, T-Mobile, or AT&T. These operators have different characteristics: high growth, lower ARPU (~$35), and aggressive bundling. Subscriber and revenue metrics are not directly comparable to the three major carriers.
    </div>
    
    <!-- Controls Section -->
    <div class="controls-section">
        <div class="glass-container controls-grid fade-in">
            <div class="control-group">
                <label class="control-label" for="metric-select">Select Metric</label>
                <select id="metric-select">
                    <option value="total_subscribers">Total Mobile (T)</option>
                    <option value="total_prepaid">Total (Pre)</option>
                    <option value="total_postpaid">Total (Post)</option>
                    <option value="verizon_total">Verizon (T)</option>
                    <option value="verizon_prepaid">Verizon (Pre)</option>
                    <option value="verizon_postpaid">Verizon (Post)</option>
                    <option value="tmobile_total">T-Mobile (T)</option>
                    <option value="tmobile_prepaid">T-Mobile (Pre)</option>
                    <option value="tmobile_postpaid">T-Mobile (Post)</option>
                    <option value="att_total">AT&amp;T (T)</option>
                    <option value="att_prepaid">AT&amp;T (Pre)</option>
                    <option value="att_postpaid">AT&amp;T (Post)</option>
                    <option value="others_total">Others (T)</option>
                    <option value="others_prepaid">Others (Pre)</option>
                    <option value="others_postpaid">Others (Post)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">Map Controls</label>
                <button id="reset-zoom">Reset Zoom</button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Tabs -->
    <div class="dashboard-tabs glass-container fade-in">
        <button class="tab-btn active" data-tab="map">US Map</button>
        <button class="tab-btn" data-tab="market-share">Market Share</button>
        <button class="tab-btn" data-tab="metros">Top Metros</button>
        <button class="tab-btn" data-tab="spectrum">Spectrum</button>
        <button class="tab-btn" data-tab="revenue">Revenue by State</button>
        <button class="tab-btn" data-tab="top-states">Top 10 States</button>
        <button class="tab-btn" data-tab="table-input">Table Input</button>
    </div>
    
    <!-- Map Container -->
    <div class="map-container tab-content active" id="tab-map">
        <div class="glass-container fade-in">
            <div id="map-svg-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading visualization...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart Panels (hidden by default) -->
    <div class="chart-panel tab-content" id="tab-market-share">
        <div class="glass-container fade-in">
            <h3>Subscriber Share by Carrier</h3>
            <div id="chart-market-share"></div>
        </div>
    </div>
    <div class="chart-panel tab-content" id="tab-metros">
        <div class="glass-container fade-in">
            <h3>Top 10 US Metro Areas by Carrier (Millions)</h3>
            <div id="chart-metros"></div>
        </div>
    </div>
    <div class="chart-panel tab-content" id="tab-spectrum">
        <div class="glass-container fade-in">
            <h3>Estimated Sub-6 GHz Spectrum Depth by Band (2026)</h3>
            <div id="chart-spectrum"></div>
        </div>
    </div>
    <div class="chart-panel tab-content" id="tab-revenue">
        <div class="glass-container fade-in">
            <h3>Estimated 2025 Annual Wireless Service Revenue by State</h3>
            <div id="chart-revenue"></div>
        </div>
    </div>
    <div class="chart-panel tab-content" id="tab-top-states">
        <div class="glass-container fade-in">
            <h3>Top 10 States by Customer Base</h3>
            <div id="chart-top-states"></div>
        </div>
    </div>
    <div class="chart-panel tab-content" id="tab-table-input">
        <div class="glass-container fade-in">
            <h3>Paste Table Data (CSV or JSON)</h3>
            <p class="help-text">Paste tabular data below. Supports CSV (comma-separated) or JSON array of objects. The app will infer columns and suggest visualizations.</p>
            <textarea id="table-input-area" placeholder="Paste CSV or JSON here...&#10;Example CSV:&#10;Name,Value,Category&#10;A,10,X&#10;B,20,Y" rows="8"></textarea>
            <button id="table-parse-btn">Parse &amp; Visualize</button>
            <div id="table-output-viz"></div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="legend" id="legend-map">
        <div class="glass-panel fade-in">
            <div class="legend-title">Color Scale</div>
            <div class="legend-scale" id="legend-scale"></div>
            <div class="legend-labels">
                <span id="legend-min">Min</span>
                <span id="legend-max">Max</span>
            </div>
        </div>
    </div>
    
    <!-- D3.js and TopoJSON - Local files with CDN fallback -->
    <script src="/static/js/d3.min.js"></script>
    <script src="/static/js/topojson.min.js"></script>

    <script>
        // Library loading state
        const MAX_CHECKS = 30; // 30 * 100ms = 3 seconds timeout
        const LOAD_CHECK_INTERVAL = 100; // ms

        // Function to wait for libraries to be available
        function waitForLibraries() {
            let checkCount = 0; // Local counter to avoid race conditions
            
            return new Promise((resolve, reject) => {
                const checkInterval = setInterval(() => {
                    checkCount++;
                    const d3Ready = typeof d3 !== 'undefined' && d3.version;
                    const topojsonReady = typeof topojson !== 'undefined';

                    if (d3Ready && topojsonReady) {
                        clearInterval(checkInterval);
                        console.log('‚úì All libraries loaded successfully');
                        console.log('  D3.js version:', d3.version);
                        console.log('  TopoJSON: Available');
                        resolve();
                    } else if (checkCount >= MAX_CHECKS) {
                        clearInterval(checkInterval);
                        reject(new Error('Libraries failed to load after ' + (MAX_CHECKS * LOAD_CHECK_INTERVAL / 1000) + ' seconds'));
                    }
                }, LOAD_CHECK_INTERVAL);
            });
        }

        // Load D3.js fallback if needed
        if (typeof d3 === 'undefined') {
            console.warn('Local D3.js failed, loading CDN fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/d3@7/dist/d3.min.js';
            script.async = false;
            script.onload = () => {
                console.log('‚úì D3.js loaded from CDN');
            };
            script.onerror = () => {
                console.error('‚úó D3.js CDN fallback failed');
            };
            document.head.appendChild(script);
        }

        // Load TopoJSON fallback if needed
        if (typeof topojson === 'undefined') {
            console.warn('Local TopoJSON failed, loading CDN fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/topojson@3/dist/topojson.min.js';
            script.async = false;
            script.onload = () => {
                console.log('‚úì TopoJSON loaded from CDN');
            };
            script.onerror = () => {
                console.error('‚úó TopoJSON CDN fallback failed');
            };
            document.head.appendChild(script);
        }
    </script>

    <!-- Fallback visualization -->
    <script src="/static/js/fallback_viz.js"></script>

    <!-- Map Visualization Script -->
    <script src="/static/js/map_semantic_zoom.js"></script>
    <script src="/static/js/charts.js"></script>

    <!-- Initialize visualization after libraries load -->
    <script>
        // Wait for DOM and libraries, then initialize
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await waitForLibraries();
                console.log('üöÄ Ready to initialize map visualization');
                
                // Tab switching
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        btn.classList.add('active');
                        const tabId = 'tab-' + btn.dataset.tab;
                        const panel = document.getElementById(tabId);
                        if (panel) panel.classList.add('active');
                        document.getElementById('legend-map').style.display = tabId === 'tab-map' ? 'block' : 'none';
                        
                        // Lazy-load charts when tab is shown
                        if (tabId === 'tab-market-share') loadMarketShare();
                        else if (tabId === 'tab-metros') loadMetros();
                        else if (tabId === 'tab-spectrum') loadSpectrum();
                        else if (tabId === 'tab-revenue') loadRevenue();
                        else if (tabId === 'tab-top-states') loadTopStates();
                    });
                });
                
                // Table input handler
                document.getElementById('table-parse-btn')?.addEventListener('click', parseTableInput);
            } catch (error) {
                console.error('Failed to load required libraries:', error);
                console.error('Using fallback visualization...');
                if (typeof createFallbackVisualization === 'function') {
                    createFallbackVisualization();
                } else {
                    document.getElementById('map-svg-container').innerHTML = `
                        <div class="loading">
                            <div class="loading-content">
                                <h2>‚ö†Ô∏è Visualization Unavailable</h2>
                                <p>Required libraries failed to load. Please refresh the page.</p>
                                <button onclick="location.reload()">Refresh Page</button>
                            </div>
                        </div>
                    `;
                }
            }
        });
    </script>
</body>
</html>
