<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapVisual - US Mobile Subscribers Visualization</title>
    
    <!-- Glassmorphism CSS -->
    <link rel="stylesheet" href="/static/css/glassmorphism.css">
    <link rel="stylesheet" href="/static/css/light-theme.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="theme-light">
    <!-- Header -->
    <div class="header">
        <h1>MapVisual Engine</h1>
        <p>Interactive US Mobile Subscribers Visualization</p>
    </div>
    
    <!-- Page Switcher -->
    <nav class="page-nav glass-container fade-in">
        <button class="page-btn active" data-page="map">Map</button>
        <button class="page-btn" data-page="data">Data &amp; Others</button>
        <button class="page-btn" data-page="analytics">Analytics</button>
    </nav>
    
    <!-- Stats Panel -->
    <div class="stats-panel page-section active" data-page="map">
        <div class="glass-container stats-grid fade-in">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">-</div>
                <div class="stat-label">Total Subscribers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-states">-</div>
                <div class="stat-label">States Shown on Map</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">32+19</div>
                <div class="stat-label">States (32 shown + 19 in Others)</div>
            </div>
        </div>
        <div id="map-total-note" class="map-total-note glass-container fade-in"></div>
    </div>
    
    <!-- Others Data Note + Data Card (Data page) -->
    <div class="info-banner glass-container fade-in page-section" data-page="data">
        <strong>Note on "Others":</strong> The "Others" row is the <strong>aggregate of the remaining 19 states</strong> (beyond the top 32) for which individual data is not shown on the map. It represents ~52.1M subscribers across those states (AR, KS, NM, NE, ID, WV, HI, NH, ME, MT, RI, DE, SD, ND, AK, VT, WY, DC, etc.).
    </div>
    <div class="others-data-card glass-container fade-in page-section" data-page="data">
        <h4>Others (19 states) ‚Äî Key Values</h4>
        <div class="data-values-grid">
            <div class="data-value-item"><span class="data-value">52.1M</span><span class="data-label">Total</span></div>
            <div class="data-value-item"><span class="data-value">41.7M</span><span class="data-label">Postpaid</span></div>
            <div class="data-value-item"><span class="data-value">10.4M</span><span class="data-label">Prepaid</span></div>
            <div class="data-value-item"><span class="data-value">15.5M</span><span class="data-label">Verizon</span></div>
            <div class="data-value-item"><span class="data-value">18.9M</span><span class="data-label">T-Mobile</span></div>
            <div class="data-value-item"><span class="data-value">16.4M</span><span class="data-label">AT&amp;T</span></div>
            <div class="data-value-item"><span class="data-value">1.3M</span><span class="data-label">Others (carriers)</span></div>
        </div>
    </div>
    
    <!-- Data Table (Data page) -->
    <div class="data-table-section page-section" data-page="data">
        <div class="glass-container fade-in">
            <h3>State-by-State Data (32 states + Others aggregate)</h3>
            <div id="data-table-container"></div>
        </div>
    </div>
    
    <!-- Controls Section -->
    <div class="controls-section page-section active" data-page="map">
        <div class="glass-container controls-grid fade-in">
            <div class="control-group">
                <label class="control-label" for="metric-select">Select Metric</label>
                <select id="metric-select" title="Others = Cable/Dish etc. (6.9M total: 5.6 Pre + 1.3 Post)">
                    <option value="total_subscribers">Total Mobile (T)</option>
                    <option value="total_prepaid">Total (Pre)</option>
                    <option value="total_postpaid">Total (Post)</option>
                    <option value="verizon_total">Verizon (T)</option>
                    <option value="verizon_prepaid">Verizon (Pre)</option>
                    <option value="verizon_postpaid">Verizon (Post)</option>
                    <option value="tmobile_total">T-Mobile (T)</option>
                    <option value="tmobile_prepaid">T-Mobile (Pre)</option>
                    <option value="tmobile_postpaid">T-Mobile (Post)</option>
                    <option value="att_total">AT&amp;T (T)</option>
                    <option value="att_prepaid">AT&amp;T (Pre)</option>
                    <option value="att_postpaid">AT&amp;T (Post)</option>
                    <option value="others_total">Others (carriers) (T)</option>
                    <option value="others_prepaid">Others (carriers) (Pre)</option>
                    <option value="others_postpaid">Others (carriers) (Post)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">Map Controls</label>
                <button id="reset-zoom">Reset Zoom</button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Tabs (Analytics page) -->
    <div class="dashboard-tabs glass-container fade-in page-section" data-page="analytics">
        <button class="tab-btn active" data-tab="market-share">Market Share</button>
        <button class="tab-btn" data-tab="metros">Top Metros</button>
        <button class="tab-btn" data-tab="spectrum">Spectrum</button>
        <button class="tab-btn" data-tab="revenue">Revenue by State</button>
        <button class="tab-btn" data-tab="top-states">Top 10 States</button>
        <button class="tab-btn" data-tab="table-input">Table Input</button>
    </div>
    
    <!-- Map Container (Map page) -->
    <div class="map-container tab-content page-section active" id="tab-map" data-page="map">
        <div class="glass-container fade-in">
            <div id="map-svg-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading visualization...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart Panels (Analytics page) -->
    <div class="chart-panel tab-content active page-section" id="tab-market-share" data-page="analytics">
        <div class="glass-container fade-in">
            <h3>Subscriber Share by Carrier</h3>
            <div id="chart-market-share"></div>
        </div>
    </div>
    <div class="chart-panel tab-content page-section" id="tab-metros" data-page="analytics">
        <div class="glass-container fade-in">
            <h3>Top 10 US Metro Areas by Carrier (Millions)</h3>
            <div id="chart-metros"></div>
        </div>
    </div>
    <div class="chart-panel tab-content page-section" id="tab-spectrum" data-page="analytics">
        <div class="glass-container fade-in">
            <h3>Estimated Sub-6 GHz Spectrum Depth by Band (2026)</h3>
            <div id="chart-spectrum"></div>
        </div>
    </div>
    <div class="chart-panel tab-content page-section" id="tab-revenue" data-page="analytics">
        <div class="glass-container fade-in">
            <h3>Estimated 2025 Annual Wireless Service Revenue by State <span id="revenue-subtitle" class="chart-subtitle"></span></h3>
            <div id="chart-revenue"></div>
        </div>
    </div>
    <div class="chart-panel tab-content page-section" id="tab-top-states" data-page="analytics">
        <div class="glass-container fade-in">
            <h3>Top 10 States by Customer Base</h3>
            <div class="chart-controls-inline">
                <label for="top-states-operator">By operator:</label>
                <select id="top-states-operator">
                    <option value="total">Total (all carriers)</option>
                    <option value="verizon">Verizon</option>
                    <option value="tmobile">T-Mobile</option>
                    <option value="att">AT&amp;T</option>
                    <option value="others">Others (carriers)</option>
                </select>
            </div>
            <div id="chart-top-states"></div>
        </div>
    </div>
    <div class="chart-panel tab-content page-section" id="tab-table-input" data-page="analytics">
        <div class="glass-container fade-in">
            <h3>Paste Table Data (CSV or JSON)</h3>
            <p class="help-text">Paste tabular data below. Supports CSV (comma-separated) or JSON array of objects. The app will infer columns and suggest visualizations.</p>
            <textarea id="table-input-area" placeholder="Paste CSV or JSON here...&#10;Example CSV:&#10;Name,Value,Category&#10;A,10,X&#10;B,20,Y" rows="8"></textarea>
            <button id="table-parse-btn">Parse &amp; Visualize</button>
            <div id="table-output-viz"></div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="legend page-section active" id="legend-map" data-page="map">
        <div class="glass-panel fade-in">
            <div class="legend-title">Color Scale</div>
            <div class="legend-scale" id="legend-scale"></div>
            <div class="legend-labels">
                <span id="legend-min">Min</span>
                <span id="legend-max">Max</span>
            </div>
        </div>
    </div>
    
    <!-- D3.js and TopoJSON - Local files with CDN fallback -->
    <script src="/static/js/d3.min.js"></script>
    <script src="/static/js/topojson.min.js"></script>

    <script>
        // Library loading state
        const MAX_CHECKS = 30; // 30 * 100ms = 3 seconds timeout
        const LOAD_CHECK_INTERVAL = 100; // ms

        // Function to wait for libraries to be available
        function waitForLibraries() {
            let checkCount = 0; // Local counter to avoid race conditions
            
            return new Promise((resolve, reject) => {
                const checkInterval = setInterval(() => {
                    checkCount++;
                    const d3Ready = typeof d3 !== 'undefined' && d3.version;
                    const topojsonReady = typeof topojson !== 'undefined';

                    if (d3Ready && topojsonReady) {
                        clearInterval(checkInterval);
                        console.log('‚úì All libraries loaded successfully');
                        console.log('  D3.js version:', d3.version);
                        console.log('  TopoJSON: Available');
                        resolve();
                    } else if (checkCount >= MAX_CHECKS) {
                        clearInterval(checkInterval);
                        reject(new Error('Libraries failed to load after ' + (MAX_CHECKS * LOAD_CHECK_INTERVAL / 1000) + ' seconds'));
                    }
                }, LOAD_CHECK_INTERVAL);
            });
        }

        // Load D3.js fallback if needed
        if (typeof d3 === 'undefined') {
            console.warn('Local D3.js failed, loading CDN fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/d3@7/dist/d3.min.js';
            script.async = false;
            script.onload = () => {
                console.log('‚úì D3.js loaded from CDN');
            };
            script.onerror = () => {
                console.error('‚úó D3.js CDN fallback failed');
            };
            document.head.appendChild(script);
        }

        // Load TopoJSON fallback if needed
        if (typeof topojson === 'undefined') {
            console.warn('Local TopoJSON failed, loading CDN fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/topojson@3/dist/topojson.min.js';
            script.async = false;
            script.onload = () => {
                console.log('‚úì TopoJSON loaded from CDN');
            };
            script.onerror = () => {
                console.error('‚úó TopoJSON CDN fallback failed');
            };
            document.head.appendChild(script);
        }
    </script>

    <!-- Fallback visualization -->
    <script src="/static/js/fallback_viz.js"></script>

    <!-- Map Visualization Script -->
    <script src="/static/js/map_semantic_zoom.js"></script>
    <script src="/static/js/charts.js"></script>

    <!-- Initialize visualization after libraries load -->
    <script>
        // Wait for DOM and libraries, then initialize
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await waitForLibraries();
                console.log('üöÄ Ready to initialize map visualization');
                
                // Page switching
                document.querySelectorAll('.page-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.page-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        const page = btn.dataset.page;
                        document.querySelectorAll('.page-section').forEach(s => {
                            s.classList.toggle('active', s.dataset.page === page);
                        });
                        document.getElementById('legend-map').style.display = (page === 'map') ? 'block' : 'none';
                        if (page === 'data') loadDataTable();
                        if (page === 'analytics') {
                            requestAnimationFrame(() => {
                                document.querySelector('.tab-btn.active')?.click();
                            });
                        }
                    });
                });
                
                // Tab switching (within Analytics page)
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        btn.classList.add('active');
                        const tabId = 'tab-' + btn.dataset.tab;
                        const panel = document.getElementById(tabId);
                        if (panel) panel.classList.add('active');
                        document.getElementById('legend-map').style.display = tabId === 'tab-map' ? 'block' : 'none';
                        
                        // Lazy-load charts when tab is shown (defer to next frame so container has dimensions)
                        const loadChart = () => {
                            if (tabId === 'tab-market-share') loadMarketShare();
                            else if (tabId === 'tab-metros') loadMetros();
                            else if (tabId === 'tab-spectrum') loadSpectrum();
                            else if (tabId === 'tab-revenue') loadRevenue();
                            else if (tabId === 'tab-top-states') loadTopStates();
                        };
                        requestAnimationFrame(() => requestAnimationFrame(loadChart));
                    });
                });
                
                // Top states operator selector
                document.getElementById('top-states-operator')?.addEventListener('change', () => {
                    if (document.querySelector('.tab-btn[data-tab="top-states"]')?.classList.contains('active')) {
                        loadTopStates();
                    }
                });
                
                // Table input handler
                document.getElementById('table-parse-btn')?.addEventListener('click', parseTableInput);
                
                // Load data table when Data page is first shown
                function loadDataTable() {
                    const container = document.getElementById('data-table-container');
                    if (!container || container.dataset.loaded === 'true') return;
                    fetch('/api/mobile/data').then(r => r.json()).then(data => {
                        if (!data.by_state || data.by_state.length === 0) {
                            container.innerHTML = '<p>No data available.</p>';
                            return;
                        }
                        const fmt = v => typeof v === 'number' ? (v >= 1 ? v.toFixed(1) : v.toFixed(2)) : (v || '-');
                        let html = '<table class="data-table data-table-operators"><thead><tr>';
                        html += '<th>State/District</th><th>Total Mobile<br><small>(Pre | Post)</small></th>';
                        html += '<th class="col-verizon">Verizon<br><small>(Total | Pre | Post)</small></th>';
                        html += '<th class="col-tmobile">T-Mobile<br><small>(Total | Pre | Post)</small></th>';
                        html += '<th class="col-att">AT&amp;T<br><small>(Total | Pre | Post)</small></th>';
                        html += '<th class="col-others">Others (carriers)<br><small>(Total | Pre | Post)</small></th>';
                        html += '</tr></thead><tbody>';
                        const totals = { total: 0, total_pre: 0, total_post: 0, vz: 0, vz_pre: 0, vz_post: 0, tm: 0, tm_pre: 0, tm_post: 0, att: 0, att_pre: 0, att_post: 0, oth: 0, oth_pre: 0, oth_post: 0 };
                        data.by_state.forEach((row, i) => {
                            totals.total += row.total_subscribers; totals.total_pre += row.total_prepaid; totals.total_post += row.total_postpaid;
                            totals.vz += row.verizon_total; totals.vz_pre += row.verizon_prepaid; totals.vz_post += row.verizon_postpaid;
                            totals.tm += row.tmobile_total; totals.tm_pre += row.tmobile_prepaid; totals.tm_post += row.tmobile_postpaid;
                            totals.att += row.att_total; totals.att_pre += row.att_prepaid; totals.att_post += row.att_postpaid;
                            totals.oth += row.others_total; totals.oth_pre += row.others_prepaid; totals.oth_post += row.others_postpaid;
                            html += '<tr>';
                            html += '<td><strong>' + (row.state_name || row.state_iso) + '</strong></td>';
                            html += '<td>' + fmt(row.total_subscribers) + '<br><small>(' + fmt(row.total_prepaid) + ' | ' + fmt(row.total_postpaid) + ')</small></td>';
                            html += '<td class="col-verizon">' + fmt(row.verizon_total) + '<br><small>(' + fmt(row.verizon_prepaid) + ' | ' + fmt(row.verizon_postpaid) + ')</small></td>';
                            html += '<td class="col-tmobile">' + fmt(row.tmobile_total) + '<br><small>(' + fmt(row.tmobile_prepaid) + ' | ' + fmt(row.tmobile_postpaid) + ')</small></td>';
                            html += '<td class="col-att">' + fmt(row.att_total) + '<br><small>(' + fmt(row.att_prepaid) + ' | ' + fmt(row.att_postpaid) + ')</small></td>';
                            html += '<td class="col-others">' + fmt(row.others_total) + '<br><small>(' + fmt(row.others_prepaid) + ' | ' + fmt(row.others_postpaid) + ')</small></td>';
                            html += '</tr>';
                        });
                        html += '<tr class="total-row"><td><strong>Total</strong></td>';
                        html += '<td><strong>' + fmt(totals.total) + '</strong><br><small>(' + fmt(totals.total_pre) + ' | ' + fmt(totals.total_post) + ')</small></td>';
                        html += '<td class="col-verizon"><strong>' + fmt(totals.vz) + '</strong><br><small>(' + fmt(totals.vz_pre) + ' | ' + fmt(totals.vz_post) + ')</small></td>';
                        html += '<td class="col-tmobile"><strong>' + fmt(totals.tm) + '</strong><br><small>(' + fmt(totals.tm_pre) + ' | ' + fmt(totals.tm_post) + ')</small></td>';
                        html += '<td class="col-att"><strong>' + fmt(totals.att) + '</strong><br><small>(' + fmt(totals.att_pre) + ' | ' + fmt(totals.att_post) + ')</small></td>';
                        html += '<td class="col-others"><strong>' + fmt(totals.oth) + '</strong><br><small>(' + fmt(totals.oth_pre) + ' | ' + fmt(totals.oth_post) + ')</small></td>';
                        html += '</tr></tbody></table>';
                        container.innerHTML = html;
                        container.dataset.loaded = 'true';
                    }).catch(e => {
                        container.innerHTML = '<p class="error">Failed to load data: ' + e.message + '</p>';
                    });
                }
            } catch (error) {
                console.error('Failed to load required libraries:', error);
                console.error('Using fallback visualization...');
                if (typeof createFallbackVisualization === 'function') {
                    createFallbackVisualization();
                } else {
                    document.getElementById('map-svg-container').innerHTML = `
                        <div class="loading">
                            <div class="loading-content">
                                <h2>‚ö†Ô∏è Visualization Unavailable</h2>
                                <p>Required libraries failed to load. Please refresh the page.</p>
                                <button onclick="location.reload()">Refresh Page</button>
                            </div>
                        </div>
                    `;
                }
            }
        });
    </script>
</body>
</html>
